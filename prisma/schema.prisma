// Minimal Next.js Fullstack Template Schema
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  role          UserRole  @default(USER)
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Authentication relations
  accounts      Account[]
  sessions      Session[]

  // Warehouse optimizer relations
  projectsCreated             Project[]              @relation("ProjectCreatedBy")
  uploads                     Upload[]               @relation("UploadUploadedBy")
  subsetsCreated              Subset[]               @relation("SubsetCreatedBy")
  transformationPipelinesCreated TransformationPipeline[] @relation("PipelineCreatedBy")

  // Meta OAuth connections
  metaConnections             MetaConnection[]

  // AI saved reports
  savedAiReports              SavedAiReport[] @relation("SavedAiReportsCreatedBy")

  // Weeztix connections
  weeztixConnections          WeeztixConnection[]

  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// APPLICATION SETTINGS
// ==========================================

model AppSettings {
  id                    String   @id @default(cuid())

  // General Settings
  siteName              String   @default("My App")
  siteUrl               String?
  timezone              String   @default("UTC")

  // Appearance Settings
  theme                 String   @default("system")
  accentColor           String   @default("#000000")

  // Notification Settings
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ==========================================
// WAREHOUSE PICK OPTIMIZER MODELS
// ==========================================

// Upload status tracking
enum UploadStatus {
  UPLOADING         // File upload in progress
  MAPPING           // Column mapping in progress
  VALIDATING        // Data validation in progress
  TRANSFORMING      // Bay transformation in progress
  COMPLETED         // All steps completed successfully
  FAILED            // Processing failed
}

// Validation severity levels
enum ValidationSeverity {
  ERROR             // Critical - blocks export
  WARNING           // Non-critical - allows export
  INFO              // Informational only
}

// Bay transformation strategies
enum BayTransformStrategy {
  NAMING_CONVENTION // Use naming patterns (e.g., "Bay-A-*" -> "Bay A")
  PHYSICAL_PROXIMITY // Group by physical coordinates
  MANUAL_MAPPING    // User-defined bay groupings
}

// Project: Top-level container for warehouse optimization work
model Project {
  id                    String            @id @default(cuid())
  name                  String
  description           String?
  clientName            String?           // Client company name

  // User reference (admin who created the project)
  createdByUserId       String
  createdBy             User              @relation("ProjectCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  // Project metadata
  isArchived            Boolean           @default(false)
  archivedAt            DateTime?

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  uploads               Upload[]
  mappingConfigs        MappingConfig[]
  subsets               Subset[]

  @@index([createdByUserId])
  @@index([isArchived])
  @@index([createdAt])
}

// Upload: Represents a single file upload with processing status
model Upload {
  id                    String            @id @default(cuid())

  // Project reference
  projectId             String
  project               Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // File metadata
  fileName              String
  originalFileName      String
  fileSize              Int               // Bytes
  filePath              String            // Vercel Blob URL
  mimeType              String            @default("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")

  // Processing status
  status                UploadStatus      @default(UPLOADING)
  statusMessage         String?           // Error message if failed

  // Processing metadata
  totalRows             Int               @default(0)
  processedRows         Int               @default(0)

  // Upload tracking
  uploadedByUserId      String
  uploadedBy            User              @relation("UploadUploadedBy", fields: [uploadedByUserId], references: [id], onDelete: Cascade)

  // Processing configuration
  mappingConfigId       String?
  mappingConfig         MappingConfig?    @relation(fields: [mappingConfigId], references: [id], onDelete: SetNull)

  // Bay transformation settings
  bayTransformStrategy  BayTransformStrategy?
  bayTransformConfig    Json?             // Strategy-specific configuration

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  completedAt           DateTime?

  // Relations
  picks                 Pick[]
  locations             Location[]
  bays                  Bay[]
  validationErrors      ValidationError[]
  paretoAnalyses        ParetoAnalysis[]
  locationUtilizations  LocationUtilization[]
  transformationPipelines TransformationPipeline[]

  @@index([projectId])
  @@index([uploadedByUserId])
  @@index([status])
  @@index([createdAt])
  @@index([fileName])
}

// Pick: Article pick information from client data
model Pick {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Template columns (7 required)
  article               String            // Article number/code
  articleDescription    String            // Article description
  family                String            // Article family/category
  pickFrequency         Float             // Picks per time period
  location              String            // Location code (must exist in Location table)
  quantity              Float             // Quantity per pick
  uniqueArticles        Int               // Number of unique articles

  // Extra dimensions (from client data beyond template requirements)
  extraDimensions       ExtraDimension[]

  // Relations
  articleLocations      ArticleLocation[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([uploadId])
  @@index([article])
  @@index([location])
  @@index([family])
  @@index([pickFrequency])
  @@unique([uploadId, article, location]) // Composite unique constraint
}

// Location: Physical warehouse location from client data
model Location {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Template columns (8 required)
  location              String            // Location code (primary key in template)
  storageType           String            // Storage type (e.g., "Pallet", "Shelf")
  locationLength        Float             // Length (meters)
  locationWidth         Float             // Width (meters)
  locationHeight        Float             // Height (meters)
  capacityLayout        String            // e.g., "0.25-0.25-0.25-0.25" (must sum to 1.0)
  locationCategory      String            // Category (e.g., "A", "B", "C")
  bay                   String            // Bay identifier (transformed from client data)

  // Parsed capacity layout (JSON array of floats that sum to 1.0)
  parsedCapacityLayout  Json              // [0.25, 0.25, 0.25, 0.25]

  // Calculated fields
  totalCapacity         Float             // Length * Width * Height

  // Bay reference (after transformation)
  bayId                 String?
  bayModel              Bay?              @relation(fields: [bayId], references: [id], onDelete: SetNull)

  // Extra dimensions
  extraDimensions       ExtraDimension[]

  // Relations
  articleLocations      ArticleLocation[]
  locationUtilizations  LocationUtilization[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@unique([uploadId, location]) // Location code must be unique within upload
  @@index([uploadId])
  @@index([bay])
  @@index([bayId])
  @@index([storageType])
  @@index([locationCategory])
}

// Bay: Grouped locations (transformed from client data)
model Bay {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Bay identification
  bayCode               String            // Unique bay code (e.g., "Bay-A", "Zone-1")
  bayName               String?           // Display name

  // Bay category (for grouping/analysis)
  category              BayCategory?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId            String?

  // Calculated metrics
  locationCount         Int               // Number of locations in this bay
  uniqueArticles        Int               // Number of unique articles in this bay
  totalPickFrequency    Float             // Sum of pick frequencies

  // CRITICAL: Referential integrity check
  // uniqueArticles <= locationCount must always be true

  // Relations
  locations             Location[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@unique([uploadId, bayCode]) // Bay code must be unique within upload
  @@index([uploadId])
  @@index([categoryId])
  @@index([uniqueArticles])
}

// BayCategory: User-defined categories for grouping bays
model BayCategory {
  id                    String            @id @default(cuid())
  name                  String
  description           String?
  color                 String?           // Hex color for UI visualization

  // Relations
  bays                  Bay[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@unique([name])
}

// ArticleLocation: Junction table for Pick-Location relationship with pick metrics
model ArticleLocation {
  id                    String            @id @default(cuid())

  // References
  pickId                String
  pick                  Pick              @relation(fields: [pickId], references: [id], onDelete: Cascade)

  locationId            String
  location              Location          @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // Metrics
  pickFrequency         Float             // Picks per time period
  quantity              Float             // Quantity at this location

  createdAt             DateTime          @default(now())

  @@unique([pickId, locationId])
  @@index([pickId])
  @@index([locationId])
}

// ValidationError: Data validation errors and warnings
model ValidationError {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Error details
  severity              ValidationSeverity
  errorCode             String            // e.g., "ORPHAN_PICK", "INVALID_CAPACITY_LAYOUT"
  errorMessage          String

  // Location in file
  rowNumber             Int?              // Row number in Excel file (1-indexed)
  columnName            String?           // Column that caused the error

  // Affected data
  affectedValue         String?           // The problematic value
  suggestedFix          String?           // Suggested correction

  createdAt             DateTime          @default(now())

  @@index([uploadId])
  @@index([severity])
  @@index([errorCode])
}

// ExtraDimension: Captures client dimensions beyond template requirements
model ExtraDimension {
  id                    String            @id @default(cuid())

  // Polymorphic reference (either Pick or Location)
  pickId                String?
  pick                  Pick?             @relation(fields: [pickId], references: [id], onDelete: Cascade)

  locationId            String?
  location              Location?         @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // Dimension details
  dimensionName         String            // Original column name from client file
  dimensionValue        String            // Value (stored as string, can be parsed later)
  dataType              String            // "string", "number", "date", "boolean"

  createdAt             DateTime          @default(now())

  @@index([pickId])
  @@index([locationId])
  @@index([dimensionName])
}

// MappingConfig: Column mapping configuration (client columns -> template columns)
model MappingConfig {
  id                    String            @id @default(cuid())

  // Project reference
  projectId             String
  project               Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Configuration details
  name                  String            // e.g., "Client ABC Standard Mapping"
  description           String?

  // Mapping JSON (client column name -> template column name)
  // Example: { "artikelnummer": "article", "omschrijving": "articleDescription" }
  pickMapping           Json              // Mapping for PICK sheet
  locationMapping       Json              // Mapping for LOCATION sheet

  // Auto-detection settings
  autoDetectThreshold   Float             @default(0.8) // Confidence threshold (0.0-1.0)

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  uploads               Upload[]

  @@index([projectId])
}

// ParetoAnalysis: KEY FEATURE - Multi-dimensional Pareto analysis
model ParetoAnalysis {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Analysis parameters
  dimension             String            // "pickFrequency", "uniqueArticles", "family", etc.
  groupBy               String?           // Optional grouping (e.g., "bay", "locationCategory")

  // Pareto results (JSON)
  // Example: [{ label: "Article-A", value: 100, percent: 25, cumulative: 25 }, ...]
  paretoData            Json

  // Metadata
  calculatedAt          DateTime          @default(now())

  @@index([uploadId])
  @@index([dimension])
  @@index([calculatedAt])
}

// LocationUtilization: Location usage metrics for BI dashboards
model LocationUtilization {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Location reference
  locationId            String
  location              Location          @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // Utilization metrics
  occupancyPercent      Float             // 0.0 - 100.0
  pickDensity           Float             // Picks per cubic meter
  turnoverRate          Float             // Pick frequency / capacity

  // Classification
  utilizationClass      String            // "Underutilized", "Optimal", "Overutilized"

  calculatedAt          DateTime          @default(now())

  @@unique([uploadId, locationId])
  @@index([uploadId])
  @@index([locationId])
  @@index([utilizationClass])
}

// Subset: User-defined data subsets for focused analysis
model Subset {
  id                    String            @id @default(cuid())

  // Project reference
  projectId             String
  project               Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Subset details
  name                  String
  description           String?

  // Filter criteria (JSON)
  // Example: { "family": ["Electronics", "Clothing"], "locationCategory": ["A"] }
  filterCriteria        Json

  // User reference
  createdByUserId       String
  createdBy             User              @relation("SubsetCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([projectId])
  @@index([createdByUserId])
}

// TransformationPipeline: Power Query & DAX transformation pipelines
model TransformationPipeline {
  id                    String            @id @default(cuid())

  // Upload reference
  uploadId              String
  upload                Upload            @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // Pipeline details
  name                  String
  description           String?

  // Pipeline steps (JSON array of transformation steps)
  // Example: [{ type: "filter", column: "pickFrequency", operator: ">", value: 10 }, ...]
  steps                 Json

  // Execution metadata
  isActive              Boolean           @default(true)
  lastExecutedAt        DateTime?
  executionCount        Int               @default(0)

  // User reference
  createdByUserId       String
  createdBy             User              @relation("PipelineCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  calculatedFields      CalculatedField[]

  @@index([uploadId])
  @@index([createdByUserId])
  @@index([isActive])
}

// CalculatedField: DAX calculated fields for custom metrics
model CalculatedField {
  id                    String            @id @default(cuid())

  // Pipeline reference
  pipelineId            String
  pipeline              TransformationPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  // Field details
  fieldName             String            // Name of the calculated field
  daxFormula            String            // DAX formula (e.g., "SUM(Pick[pickFrequency])")
  description           String?

  // Execution
  lastResult            Json?             // Cached result
  lastCalculatedAt      DateTime?

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([pipelineId])
  @@index([fieldName])
}

// ==========================================
// META BI HUB - DIMENSION TABLES
// ==========================================

enum Platform {
  FACEBOOK
  INSTAGRAM
}

enum ContentType {
  POST
  STORY
  REEL
  LIVE
  PHOTO
  VIDEO
  LINK
  STATUS
  CAROUSEL
}

enum AccountType {
  PAGE           // Facebook Page
  BUSINESS       // Instagram Business Account
  CREATOR        // Instagram Creator Account
}

enum MetaConnectionStatus {
  ACTIVE             // Connection is active and working
  TOKEN_EXPIRED      // Token has expired, needs refresh
  PERMISSIONS_REVOKED // User revoked permissions
  DISCONNECTED       // User disconnected manually
  ERROR              // Connection error
}

// ==========================================
// META OAUTH CONNECTION
// ==========================================

// OAuthState: Stores CSRF state tokens for OAuth flows (database-based, not cookies)
model OAuthState {
  id        String   @id @default(cuid())
  state     String   @unique                // The state token
  expiresAt DateTime                        // When this state expires
  createdAt DateTime @default(now())

  @@index([state])
  @@index([expiresAt])
}

// MetaConnection: OAuth connection to Meta (Facebook/Instagram)
model MetaConnection {
  id                    String               @id @default(cuid())

  // User who authorized this connection
  userId                String
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Meta user info
  metaUserId            String               // Facebook user ID
  metaUserName          String?              // Facebook user name

  // Long-lived user access token (encrypted in production)
  accessToken           String
  tokenExpiresAt        DateTime
  tokenRefreshedAt      DateTime             @default(now())

  // Scopes granted
  scopes                String[]

  // Connection status
  status                MetaConnectionStatus @default(ACTIVE)
  lastErrorMessage      String?
  lastErrorAt           DateTime?

  // Relations to connected accounts
  connectedAccounts     DimAccount[]

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@unique([userId, metaUserId])
  @@index([userId])
  @@index([status])
  @@index([tokenExpiresAt])
}

// dim_platform: Platform dimension (Facebook, Instagram)
model DimPlatform {
  id              String    @id @default(cuid())
  platform        Platform  @unique
  displayName     String    // "Facebook", "Instagram"
  apiVersion      String    // Current API version (e.g., "v21.0")

  // Relations
  accounts        DimAccount[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// dim_account: Social media accounts (Pages, IG Business)
model DimAccount {
  id                    String      @id @default(cuid())
  externalId            String      // Meta's ID for the account

  // Platform reference
  platformId            String
  platform              DimPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  // Meta OAuth connection reference
  metaConnectionId      String?
  metaConnection        MetaConnection? @relation(fields: [metaConnectionId], references: [id], onDelete: SetNull)

  // Account details
  accountType           AccountType
  name                  String      // Page/Account name
  username              String?     // @handle
  profilePictureUrl     String?

  // For Instagram: linked Facebook Page
  linkedFacebookPageId  String?

  // Access token management (legacy - for env var based tokens)
  accessToken           String?     // Encrypted in production
  tokenExpiresAt        DateTime?

  // Page-specific access token (OAuth - never expires when derived from long-lived user token)
  pageAccessToken       String?     // Page-specific token from OAuth
  pageTokenObtainedAt   DateTime?

  // Sync status
  lastSyncAt            DateTime?
  isActive              Boolean     @default(true)

  // Relations
  content               DimContent[]
  accountInsights       FactAccountInsightsDaily[]
  audienceDemographics  FactAudienceDemographics[]
  adCampaigns           DimAdCampaign[]

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@unique([platformId, externalId])
  @@index([platformId])
  @@index([metaConnectionId])
  @@index([accountType])
  @@index([isActive])
}

// dim_content: Posts, Stories, Reels, etc.
model DimContent {
  id                String      @id @default(cuid())
  externalId        String      // Meta's ID for the content

  // Account reference
  accountId         String
  account           DimAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Content details
  contentType       ContentType
  message           String?     // Post text/caption
  permalinkUrl      String?     // Link to the content

  // Media details
  mediaType         String?     // "IMAGE", "VIDEO", "CAROUSEL_ALBUM"
  mediaUrl          String?
  thumbnailUrl      String?
  videoDuration     Int?        // Duration in seconds (for video/reels)

  // Publishing info
  publishedAt       DateTime
  scheduledAt       DateTime?   // If was scheduled

  // Content metadata
  hashtags          String[]    // Extracted hashtags
  mentions          String[]    // @mentions in content

  // Relations
  contentInsights   FactContentInsights[]
  links             DimLink[]
  contentHashtags   FactContentHashtag[]
  commentSentiments FactCommentSentiment[]

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@unique([accountId, externalId])
  @@index([accountId])
  @@index([contentType])
  @@index([publishedAt])
}

// dim_date: Date dimension for time-series analytics
model DimDate {
  id              String    @id @default(cuid())
  date            DateTime  @unique @db.Date

  // Date parts
  year            Int
  quarter         Int       // 1-4
  month           Int       // 1-12
  week            Int       // 1-53 (ISO week)
  dayOfMonth      Int       // 1-31
  dayOfWeek       Int       // 0=Sunday, 6=Saturday
  dayOfYear       Int       // 1-366

  // Display names
  monthName       String    // "January"
  dayName         String    // "Monday"

  // Flags
  isWeekend       Boolean
  isHoliday       Boolean   @default(false)
  holidayName     String?

  // Festival-specific flags (for Iconic)
  isFestivalDay   Boolean   @default(false)
  festivalName    String?

  // Relations
  accountInsights         FactAccountInsightsDaily[]
  adInsights              FactAdInsightsDaily[]
  weatherData             FactWeatherDaily[]
  events                  FactEventsCalendar[]
  ticketSales             FactTicketSales[]
  contentPerformance      AggContentPerformance[]
  linkClicks              FactLinkClicks[]
  attributionDaily        AggAttributionDaily[]
  hashtagTrends           FactHashtagTrends[]
  sentimentDaily          AggSentimentDaily[]
  brandMentions           FactBrandMention[]

  // Weeztix relations
  weeztixOrders           FactWeeztixOrder[]
  weeztixDailySales       FactWeeztixDailySales[]

  @@index([year, month])
  @@index([isWeekend])
  @@index([isFestivalDay])
}

// dim_time: Time dimension for optimal posting analysis
model DimTime {
  id              String    @id @default(cuid())
  hour            Int       // 0-23
  minute          Int       // 0-59 (typically 0, 15, 30, 45)

  // Time parts
  hourOfDay       Int       // 0-23
  timeOfDay       String    // "Morning", "Afternoon", "Evening", "Night"

  // Display
  displayTime     String    // "09:00", "14:30"
  displayTime12h  String    // "9:00 AM", "2:30 PM"

  // Relations
  optimalPostingTimes     AggOptimalPostingTimes[]

  @@unique([hour, minute])
}

// ==========================================
// META BI HUB - ORGANIC FACT TABLES
// ==========================================

// fact_account_insights_daily: Page/Account level metrics
model FactAccountInsightsDaily {
  id              String      @id @default(cuid())

  // Dimension keys
  accountId       String
  account         DimAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  dateId          String
  date            DimDate     @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Page metrics (Facebook) - using new API names (Nov 2025)
  pageViews       Int?        // Formerly page_impressions
  pageFollows     Int?        // Formerly page_fans (total followers)
  pageFollowsNew  Int?        // New followers that day
  pageUnfollows   Int?        // Unfollows that day

  // Engagement metrics
  pageEngagement  Int?        // Total engagements
  pageReactions   Int?        // Reactions (likes, love, etc.)
  pageComments    Int?        // Comments
  pageShares      Int?        // Shares
  pageSaves       Int?        // Saves (Instagram)

  // Reach metrics
  pageReach       Int?        // Unique users reached
  pageImpressions Int?        // Total impressions

  // Video metrics
  videoViews      Int?        // Total video views
  videoViewTime   Int?        // Total watch time in seconds

  // Story metrics (Instagram)
  storiesCount    Int?        // Stories posted
  storiesReach    Int?        // Story reach
  storiesReplies  Int?        // Story replies

  // Profile metrics
  profileViews    Int?        // Profile visits
  websiteClicks   Int?        // Website link clicks
  emailClicks     Int?        // Email button clicks
  phoneClicks     Int?        // Phone button clicks

  // Calculated metrics
  engagementRate  Float?      // (engagements / reach) * 100
  followGrowthRate Float?     // ((new - unfollows) / total) * 100

  createdAt       DateTime    @default(now())

  @@unique([accountId, dateId])
  @@index([accountId])
  @@index([dateId])
  @@index([pageReach])
}

// fact_content_insights: Post-level metrics
model FactContentInsights {
  id              String      @id @default(cuid())

  // Dimension keys
  contentId       String
  content         DimContent  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Snapshot timestamp (metrics can be updated over time)
  snapshotAt      DateTime    @default(now())

  // Engagement metrics
  likes           Int         @default(0)
  comments        Int         @default(0)
  shares          Int         @default(0)
  saves           Int         @default(0)  // Instagram

  // Reach & impressions
  reach           Int         @default(0)
  impressions     Int         @default(0)

  // Video metrics (Reels, Videos)
  videoViews      Int?        // Views (3+ seconds)
  videoPlays      Int?        // Total plays
  videoAvgWatchTime Int?      // Average watch time in seconds
  videoRetention  Float?      // Percentage watched

  // Reel-specific metrics
  reelPlays       Int?
  reelReach       Int?
  reelShares      Int?

  // Click metrics
  linkClicks      Int?
  profileClicks   Int?

  // Reactions breakdown (Facebook)
  reactionsLike   Int?
  reactionsLove   Int?
  reactionsWow    Int?
  reactionsHaha   Int?
  reactionsSad    Int?
  reactionsAngry  Int?

  // Calculated metrics
  engagementRate  Float?      // ((likes + comments + shares + saves) / reach) * 100
  viralityRate    Float?      // (shares / reach) * 100

  createdAt       DateTime    @default(now())

  @@index([contentId])
  @@index([snapshotAt])
  @@index([engagementRate])
}

// fact_audience_demographics: Audience breakdown
model FactAudienceDemographics {
  id              String      @id @default(cuid())

  // Dimension keys
  accountId       String
  account         DimAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Snapshot info
  snapshotAt      DateTime    @default(now())

  // Demographic category
  demographicType String      // "age_gender", "country", "city", "language"

  // Breakdown data (JSON for flexibility)
  // Example for age_gender: { "18-24_male": 1500, "18-24_female": 2200, ... }
  // Example for country: { "NL": 5000, "BE": 1200, "DE": 800, ... }
  breakdown       Json

  // Total audience for this snapshot
  totalAudience   Int

  createdAt       DateTime    @default(now())

  @@index([accountId])
  @@index([demographicType])
  @@index([snapshotAt])
}

// ==========================================
// META BI HUB - PAID ADVERTISING TABLES
// ==========================================

enum AdStatus {
  ACTIVE
  PAUSED
  DELETED
  ARCHIVED
  IN_REVIEW
  DISAPPROVED
}

enum AdObjective {
  AWARENESS
  TRAFFIC
  ENGAGEMENT
  LEADS
  APP_PROMOTION
  SALES
  CONVERSIONS
}

// dim_ad_campaign: Ad campaigns
model DimAdCampaign {
  id                String        @id @default(cuid())
  externalId        String        // Meta's campaign ID

  // Account reference
  accountId         String
  account           DimAccount    @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Campaign details
  name              String
  objective         AdObjective
  status            AdStatus

  // Budget
  dailyBudget       Float?        // Daily budget in cents
  lifetimeBudget    Float?        // Lifetime budget in cents

  // Schedule
  startTime         DateTime?
  stopTime          DateTime?

  // Relations
  adSets            DimAdSet[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([accountId, externalId])
  @@index([accountId])
  @@index([status])
  @@index([objective])
}

// dim_ad_set: Ad sets within campaigns
model DimAdSet {
  id                String        @id @default(cuid())
  externalId        String        // Meta's ad set ID

  // Campaign reference
  campaignId        String
  campaign          DimAdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Ad set details
  name              String
  status            AdStatus

  // Targeting (stored as JSON for flexibility)
  targeting         Json?         // Age, gender, interests, locations, etc.

  // Budget & bidding
  dailyBudget       Float?
  lifetimeBudget    Float?
  bidStrategy       String?       // "LOWEST_COST", "BID_CAP", etc.
  bidAmount         Float?

  // Optimization
  optimizationGoal  String?       // "REACH", "LINK_CLICKS", "CONVERSIONS"

  // Relations
  ads               DimAd[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([campaignId, externalId])
  @@index([campaignId])
  @@index([status])
}

// dim_ad: Individual ads
model DimAd {
  id                String        @id @default(cuid())
  externalId        String        // Meta's ad ID

  // Ad set reference
  adSetId           String
  adSet             DimAdSet      @relation(fields: [adSetId], references: [id], onDelete: Cascade)

  // Ad details
  name              String
  status            AdStatus

  // Creative
  creativeType      String?       // "IMAGE", "VIDEO", "CAROUSEL"
  headline          String?
  bodyText          String?
  callToAction      String?       // "LEARN_MORE", "SHOP_NOW", etc.
  linkUrl           String?

  // Relations
  adInsights        FactAdInsightsDaily[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([adSetId, externalId])
  @@index([adSetId])
  @@index([status])
}

// fact_ad_insights_daily: Daily ad performance metrics
model FactAdInsightsDaily {
  id              String      @id @default(cuid())

  // Dimension keys
  adId            String
  ad              DimAd       @relation(fields: [adId], references: [id], onDelete: Cascade)
  dateId          String
  date            DimDate     @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Spend metrics
  spend           Float       @default(0)  // Amount spent in cents

  // Delivery metrics
  impressions     Int         @default(0)
  reach           Int         @default(0)
  frequency       Float?      // impressions / reach

  // Engagement metrics
  clicks          Int         @default(0)
  linkClicks      Int         @default(0)

  // Video metrics
  videoViews      Int?
  videoP25        Int?        // Viewed 25%
  videoP50        Int?        // Viewed 50%
  videoP75        Int?        // Viewed 75%
  videoP100       Int?        // Viewed 100%

  // Conversion metrics
  conversions     Int         @default(0)
  conversionValue Float       @default(0)

  // Calculated metrics
  cpm             Float?      // Cost per 1000 impressions
  cpc             Float?      // Cost per click
  ctr             Float?      // Click-through rate
  cpa             Float?      // Cost per acquisition
  roas            Float?      // Return on ad spend

  createdAt       DateTime    @default(now())

  @@unique([adId, dateId])
  @@index([adId])
  @@index([dateId])
  @@index([spend])
}

// ==========================================
// EXTERNAL DATA SOURCES (CORRELATION ANALYSIS)
// ==========================================

// fact_weather_daily: Weather data for correlation analysis
model FactWeatherDaily {
  id              String      @id @default(cuid())

  // Dimension keys
  dateId          String
  date            DimDate     @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Location
  locationLat     Float
  locationLon     Float
  locationName    String?     // City name

  // Weather data
  tempMin         Float?      // Min temperature (Celsius)
  tempMax         Float?      // Max temperature
  tempAvg         Float?      // Average temperature
  feelsLike       Float?      // "Feels like" temperature

  humidity        Int?        // Humidity percentage
  pressure        Int?        // Atmospheric pressure (hPa)

  windSpeed       Float?      // Wind speed (m/s)
  windDirection   Int?        // Wind direction (degrees)

  clouds          Int?        // Cloud cover percentage
  visibility      Int?        // Visibility (meters)

  // Weather condition
  weatherMain     String?     // "Clear", "Clouds", "Rain", etc.
  weatherDesc     String?     // Detailed description
  weatherIcon     String?     // Icon code

  // Precipitation
  rain            Float?      // Rain volume (mm)
  snow            Float?      // Snow volume (mm)

  // UV Index
  uvIndex         Float?

  createdAt       DateTime    @default(now())

  @@unique([dateId, locationLat, locationLon])
  @@index([dateId])
  @@index([weatherMain])
}

// fact_events_calendar: Events and festivals calendar
model FactEventsCalendar {
  id              String      @id @default(cuid())

  // Dimension keys
  dateId          String
  date            DimDate     @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Event details
  eventName       String
  eventType       String      // "festival", "holiday", "conference", "other"
  eventDescription String?

  // Location
  location        String?
  isVirtual       Boolean     @default(false)

  // Timing
  startTime       DateTime?
  endTime         DateTime?
  isAllDay        Boolean     @default(true)

  // Impact metrics (filled after event)
  expectedAttendance Int?
  actualAttendance   Int?

  // Tagging
  tags            String[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([dateId])
  @@index([eventType])
}

// fact_ticket_sales: Ticket sales data for correlation
model FactTicketSales {
  id              String      @id @default(cuid())

  // Dimension keys
  dateId          String      // Sale date
  date            DimDate     @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Event reference (if applicable)
  eventName       String
  eventDate       DateTime?

  // Sales data
  ticketsSold     Int
  revenue         Float       // Revenue in cents
  averagePrice    Float       // Average ticket price

  // Ticket types breakdown (JSON)
  ticketTypeBreakdown Json?   // { "Early Bird": 500, "Regular": 1200, "VIP": 100 }

  // Channel breakdown
  salesChannel    String?     // "online", "box_office", "partner"

  createdAt       DateTime    @default(now())

  @@index([dateId])
  @@index([eventName])
}

// ==========================================
// ANALYTICS & ML AGGREGATION TABLES
// ==========================================

// agg_content_performance: Aggregated content performance by type/period
model AggContentPerformance {
  id              String      @id @default(cuid())

  // Dimension keys
  dateId          String
  date            DimDate     @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Aggregation dimensions
  platform        Platform
  contentType     ContentType

  // Aggregated metrics
  totalContent    Int         // Number of posts
  totalReach      BigInt      @default(0)
  totalImpressions BigInt     @default(0)
  totalEngagement Int         @default(0)

  avgEngagementRate Float?
  avgReachPerPost Float?

  // Top performer
  topContentId    String?     // ID of best performing content
  topEngagementRate Float?

  createdAt       DateTime    @default(now())

  @@unique([dateId, platform, contentType])
  @@index([platform])
  @@index([contentType])
  @@index([dateId])
}

// agg_optimal_posting_times: Optimal posting time analysis
model AggOptimalPostingTimes {
  id              String      @id @default(cuid())

  // Dimension keys
  timeId          String
  time            DimTime     @relation(fields: [timeId], references: [id], onDelete: Cascade)

  // Aggregation dimensions
  platform        Platform
  dayOfWeek       Int         // 0=Sunday, 6=Saturday
  contentType     ContentType?

  // Performance metrics
  avgEngagementRate Float
  avgReach        Float
  sampleSize      Int         // Number of posts analyzed

  // Confidence score (0-1)
  confidenceScore Float

  // Rank for this slot
  rank            Int         // 1 = best time

  // Analysis period
  analyzedFrom    DateTime
  analyzedTo      DateTime

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([timeId, platform, dayOfWeek, contentType])
  @@index([platform])
  @@index([dayOfWeek])
  @@index([rank])
}

// ml_engagement_predictions: ML model predictions
model MlEngagementPredictions {
  id              String      @id @default(cuid())

  // Content being predicted (can be draft or published)
  contentId       String?     // Link to DimContent if published

  // Input features
  platform        Platform
  contentType     ContentType
  publishHour     Int         // Hour of day (0-23)
  publishDayOfWeek Int        // Day of week (0-6)
  captionLength   Int?
  hashtagCount    Int?
  hasMedia        Boolean     @default(true)
  mediaType       String?     // "IMAGE", "VIDEO", "CAROUSEL"

  // Historical context used
  avgEngagementLast30d Float?
  followerCount   Int?

  // Predictions
  predictedReach  Int
  predictedEngagement Int
  predictedEngagementRate Float

  // Confidence intervals
  reachLowerBound Int?
  reachUpperBound Int?
  engagementLowerBound Int?
  engagementUpperBound Int?

  // Model metadata
  modelVersion    String      // Model version used
  predictionConfidence Float  // 0-1 confidence score

  // Actual performance (filled after posting)
  actualReach     Int?
  actualEngagement Int?
  actualEngagementRate Float?
  predictionError Float?      // (actual - predicted) / predicted

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([platform])
  @@index([contentType])
  @@index([modelVersion])
  @@index([predictionConfidence])
}

// ==========================================
// LINK ATTRIBUTION (Short.io Integration)
// ==========================================

// dim_link: Tracked short links for attribution
model DimLink {
  id              String    @id @default(cuid())
  shortUrl        String    @unique  // Short.io generated URL
  originalUrl     String              // Target URL (ticket page)
  shortCode       String?             // The short code portion (e.g., "abc123")

  // Attribution metadata (UTM parameters)
  utmSource       String?             // "facebook", "instagram"
  utmMedium       String?             // "post", "story", "ad", "bio"
  utmCampaign     String?             // "summer_festival_2025"
  utmContent      String?             // Post ID or creative identifier
  utmTerm         String?             // Optional keyword/term

  // Link to content (optional - for tracking which post used this link)
  contentId       String?
  content         DimContent? @relation(fields: [contentId], references: [id], onDelete: SetNull)

  // Short.io metadata
  externalId      String?   @unique   // Short.io link ID
  domain          String?             // Custom domain used
  title           String?             // Link title for reference

  // Aggregate statistics (updated from webhooks)
  totalClicks     Int       @default(0)
  uniqueClicks    Int       @default(0)

  // Status
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  clickEvents     FactLinkClicks[]

  @@index([contentId])
  @@index([utmCampaign])
  @@index([utmSource])
  @@index([createdAt])
  @@index([isActive])
}

// fact_link_clicks: Individual click events with attribution
model FactLinkClicks {
  id              String    @id @default(cuid())

  // Dimension keys
  linkId          String
  link            DimLink   @relation(fields: [linkId], references: [id], onDelete: Cascade)
  dateId          String
  date            DimDate   @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Click metadata from Short.io webhook
  clickTimestamp  DateTime
  externalClickId String?   @unique   // Short.io click ID

  // Geographic data
  country         String?             // "NL", "BE", "DE"
  city            String?
  region          String?             // Province/state

  // Device & browser
  deviceType      String?             // "mobile", "desktop", "tablet"
  browser         String?             // "Chrome", "Safari", etc.
  os              String?             // "iOS", "Android", "Windows"

  // Referrer info
  referer         String?             // Where the click came from
  refererDomain   String?             // Domain only

  // Conversion tracking (if ticket purchased)
  converted       Boolean   @default(false)
  conversionValue Float?              // Revenue in cents
  conversionType  String?             // "ticket_purchase", "signup", etc.

  // Bot detection
  isBot           Boolean   @default(false)

  createdAt       DateTime  @default(now())

  @@index([linkId])
  @@index([dateId])
  @@index([clickTimestamp])
  @@index([converted])
  @@index([country])
  @@index([deviceType])
}

// agg_attribution_daily: Daily aggregated link attribution metrics
model AggAttributionDaily {
  id              String    @id @default(cuid())

  dateId          String
  date            DimDate   @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Clicks by platform (UTM source)
  facebookClicks  Int       @default(0)
  instagramClicks Int       @default(0)
  otherClicks     Int       @default(0)

  // Clicks by content type (UTM medium)
  postClicks      Int       @default(0)
  storyClicks     Int       @default(0)
  reelClicks      Int       @default(0)
  adClicks        Int       @default(0)
  bioClicks       Int       @default(0)

  // Geographic breakdown (top countries)
  clicksByCountry Json?               // {"NL": 500, "BE": 120, "DE": 80}

  // Device breakdown
  mobileClicks    Int       @default(0)
  desktopClicks   Int       @default(0)
  tabletClicks    Int       @default(0)

  // Conversions
  totalConversions Int      @default(0)
  conversionValue Float     @default(0)
  conversionRate  Float?              // (conversions / total clicks) * 100

  // Totals
  totalClicks     Int       @default(0)
  uniqueClicks    Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([dateId])
  @@index([dateId])
}

// ==========================================
// HASHTAG ANALYTICS (RiteTag Integration)
// ==========================================

// dim_hashtag: Hashtag dimension for tracking performance
model DimHashtag {
  id              String    @id @default(cuid())
  hashtag         String    @unique   // "#iconicfestival" (lowercase, with #)
  hashtagClean    String              // "iconicfestival" (without #)

  // RiteTag metrics (updated periodically)
  exposure        Int?                // Estimated hourly exposure
  retweets        Int?                // Expected retweets/shares per hour
  images          Int?                // Posts with images using tag
  links           Int?                // Posts with links using tag
  mentions        Int?                // Mentions per hour

  // RiteTag color (trending status)
  // green = hot/trending, blue = good for reach, red = avoid/overused
  color           String?             // "green", "blue", "red", "grey"

  // Usage tracking in our content
  timesUsed       Int       @default(0)
  lastUsedAt      DateTime?

  // Performance metrics (calculated from our data)
  avgEngagementRate Float?
  avgReach        Float?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  contentHashtags FactContentHashtag[]
  hashtagTrends   FactHashtagTrends[]

  @@index([hashtag])
  @@index([color])
  @@index([timesUsed])
}

// fact_content_hashtag: Many-to-many hashtag usage per content
model FactContentHashtag {
  id              String    @id @default(cuid())

  contentId       String
  content         DimContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  hashtagId       String
  hashtag         DimHashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  // Position in caption (for hashtag optimization analysis)
  position        Int?                // 0 = first hashtag, null = unknown
  inCaption       Boolean   @default(true)  // vs in first comment

  createdAt       DateTime  @default(now())

  @@unique([contentId, hashtagId])
  @@index([contentId])
  @@index([hashtagId])
}

// fact_hashtag_trends: Daily hashtag trending data from RiteTag
model FactHashtagTrends {
  id              String    @id @default(cuid())

  hashtagId       String
  hashtag         DimHashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)
  dateId          String
  date            DimDate   @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // RiteTag metrics snapshot
  exposure        Int
  retweets        Int
  links           Int
  images          Int
  mentions        Int
  color           String              // Trending status

  createdAt       DateTime  @default(now())

  @@unique([hashtagId, dateId])
  @@index([hashtagId])
  @@index([dateId])
  @@index([color])
}

// ==========================================
// SENTIMENT ANALYSIS (AWS Comprehend)
// ==========================================

// fact_comment_sentiment: Sentiment analysis of comments
model FactCommentSentiment {
  id              String    @id @default(cuid())

  // Content reference
  contentId       String
  content         DimContent @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Comment metadata
  commentId       String    @unique   // External comment ID from Meta
  commentText     String              // The actual comment text
  commentAuthor   String?             // Author name/username
  commentedAt     DateTime            // When the comment was posted

  // AWS Comprehend results
  sentimentLabel  String              // "POSITIVE", "NEGATIVE", "NEUTRAL", "MIXED"
  sentimentScore  Float               // Confidence 0-1 for the label
  positiveScore   Float?              // Individual sentiment scores
  negativeScore   Float?
  neutralScore    Float?
  mixedScore      Float?

  // Key phrases extracted
  keyPhrases      String[]            // ["amazing lineup", "best festival"]

  // Entities detected (JSON for flexibility)
  entities        Json?               // [{type: "EVENT", text: "Iconic Festival", score: 0.95}]

  // Language detected
  language        String?             // "en", "nl", "de"

  // Flags
  requiresResponse Boolean  @default(false)  // Negative sentiment needing attention
  responded       Boolean   @default(false)

  createdAt       DateTime  @default(now())

  @@index([contentId])
  @@index([sentimentLabel])
  @@index([commentedAt])
  @@index([requiresResponse])
}

// agg_sentiment_daily: Aggregated sentiment scores by day
model AggSentimentDaily {
  id              String    @id @default(cuid())

  dateId          String
  date            DimDate   @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Aggregated metrics
  totalComments   Int
  positiveCount   Int
  negativeCount   Int
  neutralCount    Int
  mixedCount      Int

  // Average scores
  avgSentimentScore Float             // Weighted average
  avgPositiveScore Float?
  avgNegativeScore Float?

  // Trend indicator (calculated from previous day comparison)
  sentimentTrend  String?             // "improving", "declining", "stable"
  trendDelta      Float?              // Change from previous day

  // Top phrases (JSON array)
  topPositivePhrases Json?            // ["amazing", "best ever", ...]
  topNegativePhrases Json?            // ["disappointed", "too expensive", ...]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([dateId])
  @@index([dateId])
  @@index([sentimentTrend])
}

// ==========================================
// SOCIAL LISTENING (Brand24 Integration)
// ==========================================

// dim_mention_source: Sources of brand mentions
model DimMentionSource {
  id              String    @id @default(cuid())
  platform        String              // "twitter", "facebook", "instagram", "reddit", "news", "blog"
  sourceUrl       String?   @unique   // Original source URL
  sourceName      String?             // "Reddit r/festivals", "Twitter @user", "NOS Nieuws"

  // Source metadata
  isVerified      Boolean   @default(false)  // Verified account/publication
  followerCount   Int?                // For social media sources
  domainAuthority Int?                // For websites (0-100)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  mentions        FactBrandMention[]

  @@index([platform])
}

// fact_brand_mention: Social listening mentions from Brand24
model FactBrandMention {
  id              String    @id @default(cuid())

  // Source reference
  sourceId        String
  source          DimMentionSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  dateId          String
  date            DimDate   @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Mention details
  externalId      String    @unique   // Brand24 mention ID
  mentionText     String              // The actual mention text
  mentionUrl      String?             // URL to the mention
  authorName      String?             // Author name
  authorHandle    String?             // @handle
  authorFollowers Int?                // Author's follower count

  // Timing
  mentionedAt     DateTime

  // Sentiment (from Brand24)
  sentiment       String              // "positive", "negative", "neutral"
  sentimentScore  Float?              // Confidence score

  // Reach/influence metrics
  reach           Int?                // Estimated reach
  engagement      Int?                // Likes, shares, comments
  shareOfVoice    Float?              // Percentage of total mentions

  // Keywords matched
  keywords        String[]            // ["iconic", "festival", "tickets"]

  // Categorization
  mentionType     String?             // "review", "question", "complaint", "praise"

  // Flags
  isInfluencer    Boolean   @default(false)  // High-reach mention
  requiresResponse Boolean  @default(false)  // Negative mention needing attention
  responded       Boolean   @default(false)
  responseUrl     String?             // URL to our response

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sourceId])
  @@index([dateId])
  @@index([sentiment])
  @@index([mentionedAt])
  @@index([requiresResponse])
  @@index([isInfluencer])
}

// ==========================================
// AI ANALYSIS CACHE
// ==========================================

// ai_analysis_cache: Cache for Claude AI analysis results
model AiAnalysisCache {
  id            String   @id @default(cuid())
  analysisType  String   // 'quick_insights', 'content_analysis', 'narrative_report', etc.
  inputHash     String   // MD5 hash of input parameters for cache key
  result        Json     // Cached AI response
  createdAt     DateTime @default(now())
  expiresAt     DateTime // TTL for cache invalidation

  @@unique([analysisType, inputHash])
  @@index([expiresAt])
  @@index([analysisType])
}

// saved_ai_report: User-saved AI analysis reports (permanent storage)
model SavedAiReport {
  id              String   @id @default(cuid())

  // Report metadata
  title           String                  // User-defined or auto-generated title
  reportType      String                  // 'strategic' | 'report' | 'recommendations'

  // Input parameters (for reference)
  platform        String                  // 'facebook' | 'instagram' | 'all'
  focusArea       String?                 // For strategic: 'growth' | 'engagement' | 'reach'
  month           Int?                    // For narrative report
  year            Int?                    // For narrative report
  days            Int?                    // For posting recommendations

  // The actual AI response (stored as JSON)
  content         Json                    // StrategicAdvice | NarrativeReport | PostRecommendation

  // User reference
  createdByUserId String?
  createdBy       User?    @relation("SavedAiReportsCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // Additional metadata
  notes           String?                 // User notes about the report

  // Timestamps
  createdAt       DateTime @default(now())

  @@index([createdByUserId])
  @@index([reportType])
  @@index([createdAt])
}

// ==========================================
// WEEZTIX TICKETING INTEGRATION
// ==========================================

enum WeeztixConnectionStatus {
  ACTIVE              // Connection is active and working
  TOKEN_EXPIRED       // Token has expired, needs refresh
  DISCONNECTED        // User disconnected manually
  ERROR               // Connection error
}

// WeeztixConnection: OAuth connection to Weeztix API
model WeeztixConnection {
  id                    String                    @id @default(cuid())

  // User who authorized this connection
  userId                String
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Weeztix organization info
  organizationId        String                    // Weeztix organization ID
  organizationName      String?                   // Organization/Company name

  // OAuth tokens (encrypted in production)
  accessToken           String
  refreshToken          String?
  tokenExpiresAt        DateTime
  tokenRefreshedAt      DateTime                  @default(now())

  // Scopes granted
  scopes                String[]

  // Connection status
  status                WeeztixConnectionStatus   @default(ACTIVE)
  lastErrorMessage      String?
  lastErrorAt           DateTime?

  // Last sync info
  lastSyncAt            DateTime?
  lastSyncEventsCount   Int?
  lastSyncOrdersCount   Int?

  // Relations
  events                DimWeeztixEvent[]

  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([status])
}

// DimWeeztixEvent: Events from Weeztix
model DimWeeztixEvent {
  id                    String              @id @default(cuid())
  externalId            String              // Weeztix event ID

  // Connection reference
  connectionId          String
  connection            WeeztixConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Event details
  name                  String
  description           String?
  imageUrl              String?

  // Venue info
  venueName             String?
  venueCity             String?
  venueCountry          String?

  // Event timing
  startDate             DateTime
  endDate               DateTime?
  timezone              String?             @default("Europe/Amsterdam")

  // Event status
  status                String              @default("active") // active, cancelled, sold_out, ended
  isPublished           Boolean             @default(true)

  // Capacity and sales
  totalCapacity         Int?
  ticketsSold           Int                 @default(0)
  ticketsAvailable      Int?
  soldOutAt             DateTime?

  // Revenue
  totalRevenue          Float               @default(0) // In cents
  currency              String              @default("EUR")

  // Relations
  ticketTypes           DimWeeztixTicketType[]
  orders                FactWeeztixOrder[]
  dailySales            FactWeeztixDailySales[]

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([connectionId, externalId])
  @@index([connectionId])
  @@index([startDate])
  @@index([status])
}

// DimWeeztixTicketType: Ticket types/tiers for events
model DimWeeztixTicketType {
  id                    String              @id @default(cuid())
  externalId            String              // Weeztix ticket type ID

  // Event reference
  eventId               String
  event                 DimWeeztixEvent     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Ticket details
  name                  String              // "Early Bird", "Regular", "VIP", etc.
  description           String?
  price                 Float               // Price in cents
  currency              String              @default("EUR")

  // Availability
  totalQuantity         Int?                // Total available
  quantitySold          Int                 @default(0)
  quantityAvailable     Int?
  minPerOrder           Int                 @default(1)
  maxPerOrder           Int?

  // Timing
  salesStartAt          DateTime?
  salesEndAt            DateTime?
  isOnSale              Boolean             @default(true)

  // Revenue
  totalRevenue          Float               @default(0)

  // Relations
  orderItems            FactWeeztixOrderItem[]

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([eventId, externalId])
  @@index([eventId])
  @@index([isOnSale])
}

// FactWeeztixOrder: Individual ticket orders
model FactWeeztixOrder {
  id                    String              @id @default(cuid())
  externalId            String              // Weeztix order ID

  // Event reference
  eventId               String
  event                 DimWeeztixEvent     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Date reference
  dateId                String?
  date                  DimDate?            @relation(fields: [dateId], references: [id], onDelete: SetNull)

  // Order details
  orderNumber           String?
  status                String              // pending, completed, cancelled, refunded

  // Customer info (anonymized)
  customerEmail         String?             // Hashed or partial
  customerCountry       String?
  customerCity          String?

  // Financial
  subtotal              Float               // Before fees, in cents
  serviceFee            Float               @default(0)
  totalAmount           Float               // Total paid, in cents
  currency              String              @default("EUR")

  // Payment
  paymentMethod         String?             // ideal, creditcard, etc.
  paidAt                DateTime?

  // Ticket count
  ticketCount           Int                 @default(1)

  // Marketing attribution
  utmSource             String?
  utmMedium             String?
  utmCampaign           String?
  referrer              String?

  // Device info
  deviceType            String?             // mobile, desktop, tablet
  browser               String?

  // Relations
  orderItems            FactWeeztixOrderItem[]

  createdAt             DateTime            @default(now())

  @@unique([eventId, externalId])
  @@index([eventId])
  @@index([dateId])
  @@index([status])
  @@index([createdAt])
}

// FactWeeztixOrderItem: Individual tickets within an order
model FactWeeztixOrderItem {
  id                    String              @id @default(cuid())

  // Order reference
  orderId               String
  order                 FactWeeztixOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Ticket type reference
  ticketTypeId          String
  ticketType            DimWeeztixTicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  // Item details
  quantity              Int                 @default(1)
  unitPrice             Float               // Price per ticket in cents
  totalPrice            Float               // quantity * unitPrice

  // Ticket status
  status                String              @default("valid") // valid, scanned, cancelled

  // Scan info
  scannedAt             DateTime?
  scanLocation          String?

  @@index([orderId])
  @@index([ticketTypeId])
  @@index([status])
}

// FactWeeztixDailySales: Daily aggregated sales for analytics
model FactWeeztixDailySales {
  id                    String              @id @default(cuid())

  // Event reference
  eventId               String
  event                 DimWeeztixEvent     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Date reference
  dateId                String
  date                  DimDate             @relation(fields: [dateId], references: [id], onDelete: Cascade)

  // Daily metrics
  orderCount            Int                 @default(0)
  ticketsSold           Int                 @default(0)
  revenue               Float               @default(0) // In cents

  // Breakdown by ticket type (JSON)
  ticketTypeBreakdown   Json?               // { "Early Bird": { count: 10, revenue: 5000 }, ... }

  // Payment methods (JSON)
  paymentMethodBreakdown Json?              // { "ideal": 50, "creditcard": 30, ... }

  // Device breakdown (JSON)
  deviceBreakdown       Json?               // { "mobile": 60, "desktop": 35, "tablet": 5 }

  // UTM breakdown (JSON)
  utmBreakdown          Json?               // { "facebook": 20, "instagram": 15, "google": 10 }

  // Computed averages
  averageOrderValue     Float?
  averageTicketsPerOrder Float?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([eventId, dateId])
  @@index([eventId])
  @@index([dateId])
}
